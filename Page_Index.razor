@page "/"

<div class="bar">
    <div class="@Info_GetStyleClass()">
        <Component_Button Icon="edit" OnClick="Edit_OnClick" Enabled="@(state == State.Ready)"
                          Style="position: absolute; align-self: flex-end; margin: 2.5em -.5em 0 0; " />
        <Component_Button Icon="close" OnClick="ToggleInfo" Enabled="@(state == State.Ready)"
                          Style="position: absolute; align-self: flex-end; margin: -.5em -.5em 0 0; " />
        <div class="qr" style="background-image: url(@Selection.ActiveDataItem?.qr); "></div>
    </div>
    <div class="content">
        <Component_Timer @ref="timerComponent" Context="Selection.ActiveDataItemContext" />
        <Component_Otp Context="Selection.ActiveDataItemContext" />
        @if (Selection.ActiveDataItem is not null && !infoVisible)
        {
            <Component_Button Icon="info" OnClick="ToggleInfo"
                              Style="position: absolute; right: 3.25em; " />
        }
        <Component_Button Icon="tools" OnClick="Tools_OnClick" Enabled="@(state == State.Ready)" />
    </div>
</div>
<div class="items">
    @foreach (var item in EnumerateItems())
    {
        <div class="@Item_GetStyleClass(item)"
             style="@Item_GetAdditionalStyle(item)"
             @onclick="() => Item_OnClick(item)">
            <div class="service" data-type="@item.service"></div>
            <div class="name">@item.name</div>
        </div>
    }
</div>

@implements IAsyncDisposable

@inject NavigationManager nav

@code {

    Component_Timer timerComponent;

    bool infoVisible;

    Task intervalTask;
    bool forceRender;

    enum State { Loading, Ready, Disposing, Disposed }
    State state = State.Loading;

    public async ValueTask DisposeAsync()
    {
        await Utils.WaitAsync(() => state == State.Loading);
        state = State.Disposing;
        await Utils.WaitAsync(() => state == State.Disposing);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (!firstRender)
            return;

        Selection.data = await Data.LoadAsync();
        if (Selection.ActiveDataItem is null)
            Selection.activeSecret = EnumerateItems().FirstOrDefault()?.secret;

        intervalTask = Task.Run(async () =>
        {
            while ((int) state < 2)
            {
                Selection.ComputeActiveDataItem();

                await InvokeAsync(StateHasChanged);
                await timerComponent.RenderAsync();

                if (state == State.Loading)
                {
                    state = State.Ready;
                    await InvokeAsync(StateHasChanged);
                }

                await Utils.WaitAsync(
                    condition: () => (int) state < 2 && !forceRender,
                    timeout: TimeSpan.FromSeconds(1)
                );

                forceRender = false;
            }

            Selection.ClearActiveDataItem();
            state = State.Disposed;
        });
    }

    IEnumerable<Data.Item> EnumerateItems()
    {
        if (Selection.data is null)
            yield break;

        var items = Selection.data.items
            .Where(x => !x.hidden)
            .OrderBy(x => x.service)
            .ThenBy(x => x.name);

        foreach (var item in items)
            yield return item;
    }

    string Info_GetStyleClass()
    {
        return "info" + (infoVisible ? " visible" : "");
    }

    void ToggleInfo()
    {
        infoVisible = !infoVisible;
    }

    string Item_GetStyleClass(Data.Item item)
    {
        return $"item" + (item == Selection.ActiveDataItem ? " active" : "");
    }

    string Item_GetAdditionalStyle(Data.Item item)
    {
        var color = Selection.data.colors.FirstOrDefault(x => x.name == item.service);
        if (color is null)
            return string.Empty;

        if (Selection.data.useGradients)
        {
            var gradient = string.Join(", ", [
                "transparent 0%",
                $"{color.value} 20%",
                "transparent 100%",
            ]);
            return $"background-image: linear-gradient(90deg, {gradient}); ";
        }

        return $"background-color: {color.value}; ";
    }

    void Item_OnClick(Data.Item item)
    {
        Selection.activeSecret = item.secret;
        forceRender = true;
    }

    void Edit_OnClick()
    {
        nav.NavigateTo("/edit");
    }

    void Tools_OnClick()
    {
        nav.NavigateTo("/tools");
    }

}
